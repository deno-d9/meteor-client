-- MM2 AutoFarm Premium - Part 1/2 (FIXED)
-- Fixed: Draggable GUI + Toggle Glitches

if not game:IsLoaded() then game.Loaded:Wait() end

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")
local Player = Players.LocalPlayer
local UIS = game:GetService("UserInputService")

-- Create Main GUI
local MainGui = Instance.new("ScreenGui")
MainGui.Name = "MM2PremiumFarm_Fixed"
MainGui.Parent = CoreGui

-- Main Frame
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 350, 0, 250)
MainFrame.Position = UDim2.new(0.5, -175, 0.5, -125)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
MainFrame.Parent = MainGui

-- Make draggable (FIXED)
local dragging, dragInput, dragStart, startPos

local function Update(input)
    local delta = input.Position - dragStart
    MainFrame.Position = UDim2.new(
        startPos.X.Scale, 
        startPos.X.Offset + delta.X,
        startPos.Y.Scale, 
        startPos.Y.Offset + delta.Y
    )
end

MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

MainFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

UIS.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        Update(input)
    end
end)

-- Toggles (FIXED)
local function CreateToggle(name, yPos)
    local container = Instance.new("Frame")
    container.Size = UDim2.new(0.9, 0, 0, 40)
    container.Position = UDim2.new(0.05, 0, yPos, 0)
    container.BackgroundTransparency = 1
    container.Parent = MainFrame

    local label = Instance.new("TextLabel")
    label.Text = name
    label.Size = UDim2.new(0.6, 0, 1, 0)
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.TextColor3 = Color3.new(1, 1, 1)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.Gotham
    label.TextSize = 16
    label.Parent = container

    local toggleFrame = Instance.new("Frame")
    toggleFrame.Size = UDim2.new(0.35, 0, 0.6, 0)
    toggleFrame.Position = UDim2.new(0.65, 0, 0.2, 0)
    toggleFrame.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    toggleFrame.Parent = container

    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0.5, 0)
    toggleCorner.Parent = toggleFrame

    local toggleButton = Instance.new("TextButton")
    toggleButton.Size = UDim2.new(0.45, 0, 1, 0)
    toggleButton.Position = UDim2.new(0.05, 0, 0, 0)
    toggleButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    toggleButton.AutoButtonColor = false
    toggleButton.Text = ""
    toggleButton.Parent = toggleFrame

    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0.5, 0)
    buttonCorner.Parent = toggleButton

    return {
        frame = toggleFrame,
        button = toggleButton,
        label = label,
        container = container,
        isOn = false
    }
end

-- Create Toggles
local AutoFarmToggle = CreateToggle("Auto Farm", 0.15)
local RareEggsToggle = CreateToggle("Rare Eggs", 0.35)
local NoRenderToggle = CreateToggle("No Render", 0.55)

-- Status Label
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Text = "Status: Ready"
StatusLabel.Size = UDim2.new(0.9, 0, 0, 30)
StatusLabel.Position = UDim2.new(0.05, 0, 0.75, 0)
StatusLabel.TextColor3 = Color3.new(1, 1, 1)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 14
StatusLabel.Parent = MainFrame

-- Initialize toggles properly
local function ToggleSwitch(toggle)
    toggle.isOn = not toggle.isOn
    local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.InOut)
    
    if toggle.isOn then
        local tween = TweenService:Create(toggle.button, tweenInfo, {
            Position = UDim2.new(0.5, 0, 0, 0),
            BackgroundColor3 = Color3.fromRGB(80, 200, 80)
        })
        tween:Play()
    else
        local tween = TweenService:Create(toggle.button, tweenInfo, {
            Position = UDim2.new(0.05, 0, 0, 0),
            BackgroundColor3 = Color3.fromRGB(200, 80, 80)
        })
        tween:Play()
    end
end

-- Auto-enable all features
ToggleSwitch(AutoFarmToggle)
ToggleSwitch(RareEggsToggle)
ToggleSwitch(NoRenderToggle)
RunService:Set3dRenderingEnabled(false)
-- MM2 AutoFarm Premium - Part 2/2 (FIXED)
-- Fixed: Rare egg handling + Speed 25

local attemptedRareEggs = {}
local FullBasket = false
local SavePosition = nil

-- Reset on round start
game.ReplicatedStorage.Remotes.Gameplay.RoundStart.OnClientEvent:Connect(function()
    attemptedRareEggs = {}
    FullBasket = false
    StatusLabel.Text = "Status: Farming"
end)

local function GetCoinContainer()
    for _, v in workspace:GetChildren() do
        if v:FindFirstChild("CoinContainer") then
            return v.CoinContainer
        end
    end
    return nil
end

local function CreateSavePoint()
    if not Player.Character or not Player.Character:FindFirstChild("HumanoidRootPart") then return end
    
    local part = Instance.new("Part")
    part.Size = Vector3.new(10, 1, 10)
    part.Position = Player.Character.HumanoidRootPart.Position + Vector3.new(0, 100, 0)
    part.Anchored = true
    part.Transparency = 1
    part.Parent = workspace
    SavePosition = part.CFrame * CFrame.new(0, 5, 0)
end

-- Main farming loop (SPEED 25)
spawn(function()
    while task.wait(0.1) do
        if AutoFarmToggle.isOn and Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") then
            local container = GetCoinContainer()
            if container and not FullBasket then
                -- Find coins
                local nearestCoin, minDistance = nil, math.huge
                local nearestRareEgg, rareEggDistance = nil, math.huge
                
                for _, coin in pairs(container:GetChildren()) do
                    if coin:FindFirstChild("TouchInterest") then
                        local dist = (Player.Character.HumanoidRootPart.Position - coin.Position).Magnitude
                        
                        -- Rare eggs
                        if RareEggsToggle.isOn and coin:GetAttribute("CoinID") == "RareEgg" then
                            local eggId = tostring(coin:GetAttribute("CoinUID"))
                            if not attemptedRareEggs[eggId] and dist < rareEggDistance then
                                nearestRareEgg = coin
                                rareEggDistance = dist
                            end
                        -- Normal coins
                        elseif dist < minDistance then
                            nearestCoin = coin
                            minDistance = dist
                        end
                    end
                end
                
                -- Target priority
                local target = nearestRareEgg or nearestCoin
                if target then
                    -- Mark rare egg as attempted
                    if target == nearestRareEgg then
                        attemptedRareEggs[tostring(target:GetAttribute("CoinUID"))] = true
                        StatusLabel.Text = "Status: Trying Rare Egg"
                    end
                    
                    -- Move to target (SPEED 25)
                    local tween = TweenService:Create(
                        Player.Character.HumanoidRootPart,
                        TweenInfo.new((target == nearestRareEgg and rareEggDistance or minDistance) / 25, Enum.EasingStyle.Linear),
                        {CFrame = CFrame.new(target.Position)}
                    )
                    tween:Play()
                    tween.Completed:Wait()
                    
                    StatusLabel.Text = "Status: Farming"
                end
            end
        end
    end
end)

-- Handle events
game.ReplicatedStorage.Remotes.Gameplay.CoinCollected.OnClientEvent:Connect(function(coinType, current, max)
    if coinType == "Egg" and current == max then
        FullBasket = true
        CreateSavePoint()
        if Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") then
            Player.Character.HumanoidRootPart.CFrame = SavePosition
        end
        StatusLabel.Text = "Status: Full Basket"
    end
end)

-- Toggle connections
AutoFarmToggle.container.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        ToggleSwitch(AutoFarmToggle)
    end
end)

RareEggsToggle.container.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        ToggleSwitch(RareEggsToggle)
    end
end)

NoRenderToggle.container.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        ToggleSwitch(NoRenderToggle)
        RunService:Set3dRenderingEnabled(not NoRenderToggle.isOn)
    end
end)

StatusLabel.Text = "Status: Active (Speed 25)"
